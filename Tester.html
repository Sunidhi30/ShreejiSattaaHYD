<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Subscription API Tester</title>
  <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
  <style>
    :root { --bg:#0f172a; --panel:#111827; --text:#e5e7eb; --muted:#9ca3af; --accent:#22c55e; --danger:#ef4444; --border:#1f2937; }
    * { box-sizing: border-box; }
    body { margin: 0; font-family: ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto; background: var(--bg); color: var(--text); }
    header { padding: 16px 24px; border-bottom: 1px solid var(--border); display:flex; align-items:center; justify-content:space-between; }
    h1 { font-size: 20px; margin: 0; }
    .wrap { max-width: 1200px; margin: 0 auto; padding: 18px; display: grid; grid-template-columns: 380px 1fr; gap: 18px; }
    .card { background: var(--panel); border: 1px solid var(--border); border-radius: 14px; padding: 14px; }
    .card h2 { font-size: 16px; margin: 4px 0 12px; color: var(--text); }
    label { display: block; font-size: 12px; color: var(--muted); margin: 10px 0 6px; }
    input, select, textarea { width: 100%; background: #0b1020; color: var(--text); border: 1px solid var(--border); border-radius: 10px; padding: 10px 12px; outline: none; }
    textarea { min-height: 90px; font-family: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace; font-size: 12px; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .btn { cursor: pointer; border: 1px solid var(--border); background: #0b1224; color: var(--text); padding: 10px 12px; border-radius: 10px; transition: .2s; font-weight: 600; }
    .btn:hover { transform: translateY(-1px); }
    .btn.primary { border-color: #1f4338; background: #0d1f17; }
    .btn.success { border-color: #1b4332; background: #0a1f16; color: #c7f9cc; }
    .btn.warn { border-color: #553; background: #20120b; color: #ffd7aa; }
    .btn.danger { border-color: #4c1d1d; background:#1a0b0b; color: #fecaca; }
    .stack { display: grid; gap: 10px; }
    .grid-2 { display:grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap: 10px; }
    .small { font-size: 12px; color: var(--muted); }
    .out { white-space: pre-wrap; word-break: break-word; background:#0a0f1f; padding:12px; border-radius:12px; border:1px solid var(--border); min-height: 160px; }
    .badge { display:inline-flex; align-items:center; gap:6px; padding:4px 8px; border-radius:999px; border:1px solid var(--border); background:#0b1224; font-size:12px; }
    .required { color: var(--danger); }
    code { background:#0b1224; padding: 2px 6px; border-radius:6px; border:1px solid var(--border); }
    .validation-error { color: var(--danger); font-size: 12px; margin-top: 4px; }
  </style>
</head>
<body>
  <header>
    <h1>ðŸ§ª Subscription API Tester</h1>
    <div class="badge">Uses <code>Authorization: Bearer &lt;token&gt;</code></div>
  </header>

  <div class="wrap">
    <!-- Controls -->
    <section class="card">
      <h2>ðŸ”§ Setup</h2>
      <label>Base API URL</label>
      <input id="baseUrl" value="http://localhost:9000/api/subscriptions" />

      <label>JWT (Bearer token) <span class="required">*</span></label>
      <textarea id="token">eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySWQiOiI2ODk5ZDMyMzBhMDRlODA0ZWQ5NzcyYTIiLCJpYXQiOjE3NTUwODUzOTAsImV4cCI6MTc1NTY5MDE5MH0.EJdLoZWRGq4EjS--zoXzuWRQV9iCnw2glXvcro4PYj8</textarea>

      <div class="grid-2">
        <div>
          <label>Subscription ID <span class="required">*</span></label>
          <input id="subscriptionId" placeholder="e.g. 66abc1234def56789abc0123" />
          <div id="subscriptionIdError" class="validation-error"></div>
        </div>
        <div>
          <label>Pagination (Transactions)</label>
          <div class="row">
            <input id="page" type="number" min="1" value="1" placeholder="Page" />
            <input id="limit" type="number" min="1" value="10" placeholder="Limit" />
          </div>
        </div>
      </div>

      <details style="margin-top:10px;">
        <summary class="small">Payment verification fields (from Razorpay webhook/checkout)</summary>
        <div class="stack" style="margin-top:8px;">
          <label>Payment ID <span class="required">*</span></label>
          <input id="razorpay_payment_id" placeholder="pay_XXXXXXXXX" />
          <div id="paymentIdError" class="validation-error"></div>
          
          <label>Order ID (for one-time payments)</label>
          <input id="razorpay_order_id" placeholder="order_XXXXXXXXX" />
          
          <label>Subscription ID (for recurring payments)</label>
          <input id="razorpay_subscription_id" placeholder="sub_XXXXXXXXX" />
          
          <label>Signature <span class="required">*</span></label>
          <input id="razorpay_signature" placeholder="Generated signature from Razorpay" />
          <div id="signatureError" class="validation-error"></div>
          
          <div class="small">
            <strong>Note:</strong> Either Order ID OR Subscription ID is required for verification.
          </div>
        </div>
      </details>

      <div class="row" style="margin-top:12px;">
        <button class="btn" onclick="getPlans()">GET /</button>
        <button class="btn primary" onclick="createOrder()">POST /create-order</button>
      </div>
      <div class="row">
        <button class="btn success" onclick="getMySubscriptions()">GET /user</button>
        <button class="btn" onclick="getTransactions()">GET /transactions</button>
      </div>
      <div class="row">
        <button class="btn warn" onclick="verifyPayment()">POST /verify-payment</button>
        <button class="btn danger" onclick="cancelSubscription()">POST /cancel</button>
      </div>
      
      <div style="margin-top:12px;" class="small">
        <strong>Quick Test Data:</strong><br>
        For testing, you can use these sample Razorpay IDs:<br>
        â€¢ Payment: <code onclick="$('razorpay_payment_id').value=this.textContent">pay_29QQoUBi66xm2f</code><br>
        â€¢ Order: <code onclick="$('razorpay_order_id').value=this.textContent">order_9A33XWu170gUtm</code><br>
        â€¢ Signature: <code onclick="$('razorpay_signature').value=this.textContent">0cf0eb6eb9640ce5ce40a3857d6c9999</code>
      </div>
    </section>

    <!-- Output -->
    <section class="card">
      <h2>ðŸ“¤ Response</h2>
      <div id="status" class="small">Ready.</div>
      <div id="output" class="out">Responses will appear hereâ€¦</div>
    </section>
  </div>

  <script>
    const $ = (id) => document.getElementById(id);

    // Clear validation errors
    function clearErrors() {
      document.querySelectorAll('.validation-error').forEach(el => el.textContent = '');
    }

    // Show validation error
    function showError(elementId, message) {
      const errorEl = document.getElementById(elementId + 'Error');
      if (errorEl) errorEl.textContent = message;
    }

    // Validate required fields for verification
    function validateVerificationFields() {
      clearErrors();
      let isValid = true;

      const subscriptionId = $("subscriptionId").value.trim();
      const paymentId = $("razorpay_payment_id").value.trim();
      const signature = $("razorpay_signature").value.trim();
      const orderId = $("razorpay_order_id").value.trim();
      const subId = $("razorpay_subscription_id").value.trim();

      if (!subscriptionId) {
        showError('subscriptionId', 'Subscription ID is required');
        isValid = false;
      }

      if (!paymentId) {
        showError('paymentId', 'Payment ID is required');
        isValid = false;
      }

      if (!signature) {
        showError('signature', 'Signature is required');
        isValid = false;
      }

      if (!orderId && !subId) {
        showError('paymentId', 'Either Order ID or Subscription ID is required');
        isValid = false;
      }

      return isValid;
    }

    function authHeader() {
      const t = $("token").value.trim();
      return t ? { Authorization: `Bearer ${t.startsWith('Bearer ') ? t.split(' ')[1] : t}` } : {};
    }

    async function api(method, path, body, query) {
      clearErrors();
      const base = $("baseUrl").value.replace(/\/$/, "");
      const url = new URL(base + path);
      if (query) {
        Object.entries(query).forEach(([k,v]) => {
          if (v !== undefined && v !== '') {
            url.searchParams.set(k, v);
          }
        });
      }

      $("status").textContent = `${method} ${url.pathname}${url.search}`;
      const opts = {
        method,
        headers: {
          'Content-Type': 'application/json',
          ...authHeader(),
        },
      };
      if (body) opts.body = JSON.stringify(body);

      const started = performance.now();
      try {
        const res = await fetch(url, opts);
        const text = await res.text();
        let data;
        try { 
          data = JSON.parse(text); 
        } catch { 
          data = text; 
        }
        const ms = Math.round(performance.now() - started);
        
        $("output").textContent = JSON.stringify({
          ok: res.ok,
          status: res.status,
          endpoint: url.toString(),
          time_ms: ms,
          response: data,
        }, null, 2);
        
        // Auto-scroll to see response
        $("output").scrollTop = 0;
        return data;
      } catch (err) {
        $("output").textContent = `Network Error: ${err?.message || err}`;
        throw err;
      }
    }

    // --- Endpoint actions ---
    function getPlans() {
      api('GET', '');
    }

    async function createOrder() {
      const subscriptionId = $("subscriptionId").value.trim();
      if (!subscriptionId) {
        showError('subscriptionId', 'Subscription ID is required');
        return;
      }

      try {
        // Step 1: Get order from backend
        const response = await api('POST', '/create-order', { subscriptionId });
        
        if (!response?.data?.orderId) {
          throw new Error('No orderId received from backend');
        }

        // Step 2: Initialize Razorpay checkout
        const options = {
          key: "rzp_test_7m8iz2GqqZ6H9C", // Replace with your Razorpay test key
          amount: response.data.amount,
          currency: response.data.currency || "INR",
          order_id: response.data.orderId,
          name: response.data.subscription.name + " Subscription",
          description: "Access to premium features",
          prefill: {
            name: response.data.userDetails.name,
            email: response.data.userDetails.email,
            contact: response.data.userDetails.contact.toString(),
          },
          handler: function(response) {
            // Payment success callback
            alert(`Payment successful!\nPayment ID: ${response.razorpay_payment_id}\nOrder ID: ${response.razorpay_order_id}`);
            
            // Auto-fill verification fields
            $("razorpay_payment_id").value = response.razorpay_payment_id;
            $("razorpay_order_id").value = response.razorpay_order_id;
            $("razorpay_signature").value = response.razorpay_signature;
          },
          theme: {
            color: "#0f172a"
          },
          modal: {
            ondismiss: function() {
              console.log("Payment window closed");
            }
          }
        };

        const rzp = new Razorpay(options);
        rzp.open();
      } catch (error) {
        console.error("Payment error:", error);
        alert("Payment failed: " + error.message);
      }
    }

    function verifyPayment() {
      if (!validateVerificationFields()) {
        return;
      }

      const body = {
        razorpay_payment_id: $("razorpay_payment_id").value.trim(),
        razorpay_order_id: $("razorpay_order_id").value.trim(),
        razorpay_subscription_id: $("razorpay_subscription_id").value.trim(),
        razorpay_signature: $("razorpay_signature").value.trim(),
        subscriptionId: $("subscriptionId").value.trim(),
      };

      // Remove empty fields
      Object.keys(body).forEach(key => {
        if (!body[key]) delete body[key];
      });

      api('POST', '/verify-payment', body);
    }

    function getMySubscriptions() {
      api('GET', '/user');
    }

    function getTransactions() {
      const page = $("page").value;
      const limit = $("limit").value;
      api('GET', '/transactions', null, { page, limit });
    }

    function cancelSubscription() {
      const subscriptionId = $("subscriptionId").value.trim();
      if (!subscriptionId) {
        showError('subscriptionId', 'Subscription ID is required');
        return;
      }
      api('POST', '/cancel', { subscriptionId });
    }

    // Pre-fill helper from provided Bearer token (if user pasted full string)
    (function normalizeTokenIfNeeded(){
      const t = $("token").value.trim();
      if (t.startsWith('Bearer ')) {
        $("token").value = t.replace(/^Bearer\s+/,'');
      }
    })();
  </script>
</body>
</html>